<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>QuietPath â€¢ Funeral Cost Calculator</title>
  <link href="https://fonts.googleapis.com/css2?family=Lato:wght@400;600;700&family=Raleway:wght@700;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#fcfbf9; --fg:#111; --muted:#6b7280;
      --blue:#5a7da3; --plum:#6e608c; --sand:#e8dcc8; --white:#fff;
      --border:#e5e7eb; --focus:#ffbf47; --danger:#8b1c1c;
      --success:#116149; --btn:#4a5d5a; --btn-hover:#3d4f4c;
      --disabled:#9aa0a6;
    }
    html,body{margin:0;padding:0;background:var(--bg);color:var(--fg);
      font-family:Lato,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
      line-height:1.6;font-size:16px;}
    .container{max-width:1200px;margin:0 auto;padding:24px 18px 64px;}
    h1{font-family:Raleway,Lato,sans-serif;font-weight:800;color:var(--blue);
       font-size:clamp(1.6rem,3vw,2.2rem);margin:4px 0 10px;}
    .lede{color:var(--muted);max-width:72ch;}
    .notice{margin:10px 0;background:var(--white);border:1px solid var(--border);
      border-radius:14px;padding:12px 14px;}
    .intro-card{background:var(--sand);border:1px solid var(--border);border-radius:16px;padding:18px;display:grid;gap:8px;}
    .cta-row{display:flex;gap:10px;flex-wrap:wrap;margin-top:4px;}
    .btn{appearance:none;border:1px solid var(--blue);background:var(--blue);color:#fff;
      border-radius:999px;padding:10px 14px;font-size:1rem;cursor:pointer;}
    .btn.secondary{background:transparent;color:var(--blue);}
    .btn.ghost{background:transparent;border-color:var(--border);color:var(--fg);}
    .btn.small{padding:8px 12px;font-size:.95rem;}
    .btn.inline{padding:0;border:none;background:none;color:var(--blue);text-decoration:underline;}
    .btn.download{background:var(--btn);border-color:var(--btn);color:#fff;}
    .btn.download:hover{background:var(--btn-hover);border-color:var(--btn-hover);}
    .btn:focus{outline:3px solid var(--focus);outline-offset:2px;}

    /* Layout: left content + right rail sticky summary on desktop */
    .layout{
      display:grid;grid-template-columns:1fr;gap:16px;margin-top:16px;
    }
    @media(min-width: 1000px){
      .layout{grid-template-columns: 2fr 1fr;}
      .rail{position: sticky; top: 16px; height: fit-content;}
    }

    .card{background:#fff;border:1px solid var(--border);border-radius:16px;padding:16px;box-shadow:0 1px 2px rgba(0,0,0,.04);}
    .section-title{font-family:Raleway,Lato,sans-serif;font-weight:700;color:var(--plum);margin:0 0 8px;font-size:1.15rem;}

    .controls .row{display:flex;gap:10px;align-items:center;padding:10px 0;border-bottom:1px dashed var(--border);flex-wrap:wrap;}
    .controls .row:last-child{border-bottom:none;}
    label.muted{color:var(--muted);min-width:150px;}
    select{font-size:1rem;padding:10px 12px;border-radius:12px;border:1px solid var(--border);background:#fff;color:var(--fg);}
    .togglebar{display:flex;gap:8px;flex-wrap:wrap;}
    .pill{border:1px solid var(--border);background:#fff;border-radius:999px;padding:8px 12px;cursor:pointer;}
    .pill[aria-pressed="true"]{border-color:var(--blue);box-shadow:inset 0 0 0 1px var(--blue);color:var(--blue);font-weight:700;}

    /* Summary buckets */
    .summary{display:grid;gap:10px;}
    .bucket{display:flex;justify-content:space-between;padding:10px 12px;border:1px solid var(--border);border-radius:12px;background:#fafafa;}
    .bucket .name{font-weight:600;}
    .bucket .amt{font-weight:700;}
    .grand{display:flex;justify-content:space-between;padding:12px;border-top:2px solid var(--border);font-weight:800;font-size:1.2rem;color:var(--blue);}
    .small{color:var(--muted);font-size:.95rem;}

    /* Itemized groups: single table per category, all items visible */
    .group{margin-top:12px;border-top:1px solid var(--border);padding-top:10px;}
    .group h3{display:flex;justify-content:space-between;align-items:baseline;font-family:Raleway,Lato,sans-serif;
      color:var(--blue);font-size:1.05rem;margin:0 0 8px;}
    .group h3 .subtotal{font-weight:700;}
    table{width:100%;border-collapse:collapse;table-layout:fixed;}
    thead th{padding:10px;border-bottom:1px solid var(--border);text-align:left;background:#f7f7f8;}
    tbody td{padding:10px;border-bottom:1px solid var(--border);vertical-align:middle;}
    .col-item{width:56%;} .col-amt{width:22%;text-align:right;} .col-act{width:22%;text-align:right;}

    .amount{font-variant-numeric:tabular-nums;font-weight:700;}
    .row-disabled .amount{color:var(--disabled); text-decoration: line-through;}
    .row-disabled .col-item{color:var(--disabled);}
    .badge{display:inline-block; margin-left:8px; padding:2px 8px; border-radius:999px; background:#f3f4f6; color:#6b7280; font-size:.85rem;}

    .amount.editing input{width:140px;padding:8px 10px;border:1px solid var(--border);border-radius:10px;font-size:1rem;text-align:right;}
    .muted{color:#9aa0a6;}

    .footer-actions{display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end;margin-top:16px;}

    @media print{
      #optionsToggle,#itemsToggle,.footer-actions,.intro-card .cta-row{display:none !important;}
      .container{padding:0;} body{background:#fff;} .card{box-shadow:none;border-color:#ddd;}
    }
    :focus{outline:3px solid var(--focus);outline-offset:2px;}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>Funeral Cost Calculator</h1>
      <p class="lede">A starting point to see typical costs, without pressure to decide everything right now.</p>
      <div class="intro-card">
        <div class="notice"><strong>About these numbers:</strong> Estimates use national averages from public sources. These are typical costs. Please consult your local funeral home or crematory for actual pricing.</div>
        <div class="cta-row">
          <button id="itemsToggle" class="btn">Hide itemized costs</button>
          <button id="optionsToggle" class="btn secondary">Hide options</button>
        </div>
      </div>
    </header>

    <div class="layout">
      <!-- Left column: Options + Items -->
      <div class="main">
        <!-- Options (open by default, collapsible) -->
        <section class="card" id="optionsSection">
          <h2 class="section-title">Options</h2>
          <div class="controls">
            <div class="row">
              <label class="muted">Scenario</label>
              <div class="togglebar" role="group" aria-label="Scenario">
                <button class="pill" id="opt-burial" aria-pressed="true">Burial</button>
                <button class="pill" id="opt-cremation" aria-pressed="false">Cremation</button>
              </div>
            </div>
            <div class="row">
              <label class="muted">Service level</label>
              <div class="togglebar" role="group" aria-label="Service level">
                <button class="pill" id="svc-full" aria-pressed="true">Full service</button>
                <button class="pill" id="svc-mem" aria-pressed="false">Memorial/Graveside only</button>
                <button class="pill" id="svc-none" aria-pressed="false">No service</button>
              </div>
            </div>
            <div class="row" id="row-open-casket">
              <label class="muted">Open casket?</label>
              <div class="togglebar" role="group" aria-label="Open casket">
                <button class="pill" id="open-yes" aria-pressed="true">Yes</button>
                <button class="pill" id="open-no" aria-pressed="false">No</button>
              </div>
            </div>
            <div class="row">
              <label for="stateSelect" class="muted">State</label>
              <select id="stateSelect"></select>
            </div>
            <div class="row">
              <label class="muted">Cemetery costs</label>
              <div class="togglebar">
                <button class="pill" id="cem-on" aria-pressed="true">On</button>
                <button class="pill" id="cem-off" aria-pressed="false">Off</button>
              </div>
            </div>
          </div>
        </section>

        <!-- Itemized (open by default, collapsible) -->
        <section class="card" id="itemsSection" style="margin-top:16px;">
          <h2 class="section-title">Itemized costs</h2>

          <div class="group" id="grpFuneral">
            <h3>Funeral home services <span class="subtotal" id="subFuneral">$0</span></h3>
            <table>
              <thead><tr><th class="col-item">Item</th><th class="col-amt">Amount</th><th class="col-act">Actions</th></tr></thead>
              <tbody id="bodyFuneral"></tbody>
            </table>
          </div>

          <div class="group" id="grpTransport">
            <h3>Transportation <span class="subtotal" id="subTransport">$0</span></h3>
            <table>
              <thead><tr><th class="col-item">Item</th><th class="col-amt">Amount</th><th class="col-act">Actions</th></tr></thead>
              <tbody id="bodyTransport"></tbody>
            </table>
          </div>

          <div class="group" id="grpCeremony">
            <h3>Viewing & ceremony <span class="subtotal" id="subCeremony">$0</span></h3>
            <table>
              <thead><tr><th class="col-item">Item</th><th class="col-amt">Amount</th><th class="col-act">Actions</th></tr></thead>
              <tbody id="bodyCeremony"></tbody>
            </table>
          </div>

          <div class="group" id="grpBurial">
            <h3>Burial & cemetery <span class="subtotal" id="subBurial">$0</span></h3>
            <table>
              <thead><tr><th class="col-item">Item</th><th class="col-amt">Amount</th><th class="col-act">Actions</th></tr></thead>
              <tbody id="bodyBurial"></tbody>
            </table>
          </div>

          <div class="group" id="grpCremation">
            <h3>Cremation <span class="subtotal" id="subCremation">$0</span></h3>
            <table>
              <thead><tr><th class="col-item">Item</th><th class="col-amt">Amount</th><th class="col-act">Actions</th></tr></thead>
              <tbody id="bodyCremation"></tbody>
            </table>
          </div>

          <div class="footer-actions">
            <button id="btnPrint" class="btn secondary small">Print / Save as PDF</button>
            <button id="btnCSV" class="btn download small">Download CSV</button>
          </div>
        </section>
      </div>

      <!-- Right rail: sticky estimate -->
      <aside class="rail">
        <section class="card" aria-labelledby="estTitle">
          <h2 id="estTitle" class="section-title">Your Estimate</h2>
          <div id="summary" class="summary"></div>
          <div class="grand"><span>Total estimate</span><span id="grandTotal">$0</span></div>
          <p class="small">You can adjust details. Changes update this summary automatically.</p>
        </section>
      </aside>
    </div>
  </div>

  <script>
    // ------------------ Data ------------------
    const STATE_MULT = {
      "California":1.2,"New York":1.2,"Massachusetts":1.2,"Connecticut":1.2,"New Jersey":1.2,
      "District of Columbia":1.2,"Washington":1.2,"Oregon":1.2,"Hawaii":1.2,"Alaska":1.2,"Maryland":1.2,
      "Alabama":0.8,"Arkansas":0.8,"Mississippi":0.8,"Oklahoma":0.8,"Kentucky":0.8,"West Virginia":0.8,
      "Louisiana":0.8,"Tennessee":0.8,"Missouri":0.8,"New Mexico":0.8,"South Carolina":0.8,"Idaho":0.8
    };
    const ALL_STATES = ["National average","Alabama","Alaska","Arizona","Arkansas","California","Colorado","Connecticut","Delaware","District of Columbia","Florida","Georgia","Hawaii","Idaho","Illinois","Indiana","Iowa","Kansas","Kentucky","Louisiana","Maine","Maryland","Massachusetts","Michigan","Minnesota","Mississippi","Missouri","Montana","Nebraska","Nevada","New Hampshire","New Jersey","New Mexico","New York","North Carolina","North Dakota","Ohio","Oklahoma","Oregon","Pennsylvania","Rhode Island","South Carolina","South Dakota","Tennessee","Texas","Utah","Vermont","Virginia","Washington","West Virginia","Wisconsin","Wyoming"];

    const GROUPS = ["funeral","transport","ceremony","burial","cremation"];

    const ITEMS = [
      {id:"basic_services",label:"Basic services of funeral director and staff",base:2300,group:"funeral",applies:"both"},
      {id:"transfer",label:"Transfer of remains",base:350,group:"transport",applies:"both"},
      {id:"embalming",label:"Embalming",base:750,group:"funeral",applies:"burial"},
      {id:"viewing",label:"Viewing / visitation",base:450,group:"ceremony",applies:"both"},
      {id:"ceremony",label:"Funeral ceremony",base:500,group:"ceremony",applies:"both"},
      {id:"hearse",label:"Hearse",base:350,group:"transport",applies:"burial"},
      {id:"service_car",label:"Service car / van",base:150,group:"transport",applies:"both"},
      {id:"metal_casket",label:"Metal casket",base:2500,group:"burial",applies:"burial"},
      {id:"vault",label:"Vault",base:1500,group:"burial",applies:"burial",isCemetery:true},
      {id:"plot",label:"Cemetery plot",base:2000,group:"burial",applies:"both",isCemetery:true},
      {id:"opening",label:"Opening / closing grave",base:1200,group:"burial",applies:"both",isCemetery:true},
      {id:"headstone",label:"Headstone / marker",base:2000,group:"burial",applies:"both",isCemetery:true},
      {id:"cremation_fee",label:"Cremation fee",base:350,group:"cremation",applies:"cremation"},
      {id:"urn",label:"Urn",base:250,group:"cremation",applies:"cremation"},

      // Optional/common add-ons (visible but disabled by default)
      {id:"programs",label:"Printed programs / memorial cards",base:180,group:"ceremony",applies:"both",optional:true,enabled:false},
      {id:"flowers",label:"Flowers",base:150,group:"ceremony",applies:"both",optional:true,enabled:false},
      {id:"obituary",label:"Obituary / announcement fees",base:100,group:"ceremony",applies:"both",optional:true,enabled:false},
      {id:"honorarium",label:"Clergy / celebrant honorarium",base:200,group:"ceremony",applies:"both",optional:true,enabled:false},
      {id:"catering",label:"Family gathering / catering",base:300,group:"ceremony",applies:"both",optional:true,enabled:false},
      {id:"liner",label:"Grave liner (if not using vault)",base:900,group:"burial",applies:"burial",optional:true,enabled:false},

      // Open-casket related
      {id:"presentation",label:"Presentation prep (dressing/cosmetics)",base:200,group:"funeral",applies:"burial",optional:true,enabled:false},
      {id:"refrigeration",label:"Refrigeration (per day)",base:100,group:"funeral",applies:"both",optional:true,enabled:false,qtyFactor:true,qty:1}
    ];

    // ------------------ State ------------------
    let scenario = "burial";          // burial | cremation
    let serviceLevel = "full";         // full | mem | none
    let cemeteryOn = true;             // cemetery costs
    let openCasket = true;             // only for serviceLevel=full
    let multiplier = 1.0;

    const itemState = new Map(); // id -> {enabled, amount, qty}
    const history = [];

    function snapshot(){
      const snap = {
        scenario, serviceLevel, cemeteryOn, openCasket, multiplier,
        items: Array.from(itemState.entries()).map(([id,st]) => [id,{...st}])
      };
      history.push(snap);
      if(history.length>50) history.shift();
    }
    function undo(){
      const snap = history.pop();
      if(!snap) return;
      scenario = snap.scenario;
      serviceLevel = snap.serviceLevel;
      cemeteryOn = snap.cemeteryOn;
      openCasket = snap.openCasket;
      multiplier = snap.multiplier;
      itemState.clear();
      snap.items.forEach(([id,st]) => itemState.set(id,{...st}));
      renderAll();
    }

    function defaultEnabled(it){
      const applies = it.applies==="both" || it.applies===scenario;
      if(!applies) return false;
      if(it.isCemetery && !cemeteryOn) return false;
      if(it.id==="viewing"){ return serviceLevel==="full"; }
      if(it.id==="ceremony"){ return serviceLevel==="full" || serviceLevel==="mem"; }
      if(it.id==="service_car"){ return serviceLevel==="full"; }
      if(it.id==="embalming"){
        if(scenario==="cremation") return false;
        if(serviceLevel!=="full") return false;
        return openCasket;
      }
      if(it.id==="presentation"){
        return serviceLevel==="full" && openCasket && scenario==="burial";
      }
      if(it.id==="refrigeration"){
        const embalmingOn = scenario==="burial" && serviceLevel==="full" && openCasket;
        return !embalmingOn && (serviceLevel!=="none");
      }
      if(it.optional && it.enabled===false) return false;
      return true;
    }

    function initDefaults(){
      itemState.clear();
      ITEMS.forEach(it => {
        itemState.set(it.id, { enabled: defaultEnabled(it), amount: it.base, qty: it.qtyFactor ? (it.qty||1) : 1 });
      });
    }

    const fmtUSD = n => Number(n).toLocaleString(undefined,{style:"currency",currency:"USD",maximumFractionDigits:0});

    // ----- Rendering -----
    const stateSelect = document.getElementById("stateSelect");
    const optionsSection = document.getElementById("optionsSection");
    const itemsSection = document.getElementById("itemsSection");
    const itemsToggle = document.getElementById("itemsToggle");
    const optionsToggle = document.getElementById("optionsToggle");

    function buildStateSelect(){
      stateSelect.innerHTML = "";
      ALL_STATES.forEach(s => {
        const opt=document.createElement("option");
        opt.value=s; opt.textContent=s;
        stateSelect.appendChild(opt);
      });
      stateSelect.value="National average";
      multiplier = 1.0;
    }

    function applyState(){
      const s = stateSelect.value;
      multiplier = (s==="National average") ? 1.0 : (STATE_MULT[s] || 1.0);
      renderAll();
    }

    const bodies = {
      funeral: document.getElementById("bodyFuneral"),
      transport: document.getElementById("bodyTransport"),
      ceremony: document.getElementById("bodyCeremony"),
      burial: document.getElementById("bodyBurial"),
      cremation: document.getElementById("bodyCremation")
    };
    const subEls = {
      funeral: document.getElementById("subFuneral"),
      transport: document.getElementById("subTransport"),
      ceremony: document.getElementById("subCeremony"),
      burial: document.getElementById("subBurial"),
      cremation: document.getElementById("subCremation")
    };

    function renderItems(){
      Object.values(bodies).forEach(el => el.innerHTML="");
      ITEMS.forEach(it => {
        const applies = it.applies==="both" || it.applies===scenario;
        if(!applies) return;
        if(it.isCemetery && !cemeteryOn) return;
        const st = itemState.get(it.id); if(!st) return;

        const tr = document.createElement("tr");
        if(!st.enabled) tr.classList.add("row-disabled");

        const tdItem = document.createElement("td");
        tdItem.className="col-item";
        tdItem.textContent = it.label + (it.qtyFactor && st.qty>1 ? ` Ã— ${st.qty}` : "");

        const tdAmt = document.createElement("td");
        tdAmt.className="col-amt";
        const spanAmt = document.createElement("span");
        spanAmt.className="amount";
        const lineTotal = (st.amount||0) * (it.qtyFactor ? st.qty||1 : 1);
        spanAmt.textContent = fmtUSD(lineTotal);
        tdAmt.appendChild(spanAmt);

        const tdAct = document.createElement("td");
        tdAct.className="col-act";
        const actWrap = document.createElement("div");

        // Actions depend on enabled state
        if(st.enabled){
          const edit = document.createElement("button");
          edit.className="btn inline";
          edit.textContent="Edit";
          edit.addEventListener("click", () => {
            snapshot();
            tdAmt.innerHTML="";
            const wrap = document.createElement("div");
            wrap.className="amount editing";
            const input = document.createElement("input");
            input.type="number"; input.min="0"; input.step="50"; input.value=st.amount;
            wrap.appendChild(input);
            if(it.qtyFactor){
              const q = document.createElement("input");
              q.type="number"; q.min="1"; q.step="1"; q.value=st.qty||1;
              q.style.marginLeft="8px"; q.style.width="70px";
              q.setAttribute("aria-label","Quantity");
              wrap.appendChild(q);
              q.addEventListener("blur", () => { st.qty = Math.max(1, Number(q.value)||1); renderAll(); });
              q.addEventListener("keydown", e => { if(e.key==="Enter"){ q.blur(); }});
            }
            tdAmt.appendChild(wrap);
            input.focus();
            const commit = () => { st.amount = Number(input.value)||0; renderAll(); };
            input.addEventListener("blur", commit);
            input.addEventListener("keydown", e => { if(e.key==="Enter"){ input.blur(); }});
          });

          const sep = document.createElement("span");
          sep.textContent=" | ";
          sep.className="muted";

          const remove = document.createElement("button");
          remove.className="btn inline";
          remove.textContent="Remove";
          remove.addEventListener("click", () => { snapshot(); st.enabled=false; renderAll(); });

          actWrap.appendChild(edit);
          actWrap.appendChild(sep);
          actWrap.appendChild(remove);
        } else {
          // Not included state: "Add" + badge
          const add = document.createElement("button");
          add.className="btn inline";
          add.textContent="Add";
          add.addEventListener("click", () => { snapshot(); st.enabled=true; renderAll(); });
          actWrap.appendChild(add);

          const badge = document.createElement("span");
          badge.className="badge";
          badge.textContent="Not included";
          actWrap.appendChild(badge);
        }

        tdAct.appendChild(actWrap);

        const tbody = bodies[it.group];
        const row = document.createElement("tr");
        row.appendChild(tdItem); row.appendChild(tdAmt); row.appendChild(tdAct);
        tbody.appendChild(row);
      });

      // hide empty groups and compute subtotals
      GROUPS.forEach(g => {
        const groupEl = document.getElementById("grp"+g.charAt(0).toUpperCase()+g.slice(1));
        const subEl = subEls[g];
        const rows = bodies[g].children.length;
        groupEl.style.display = rows ? "" : "none";
        subEl.textContent = fmtUSD(groupSubtotal(g));
      });
    }

    function groupSubtotal(group){
      let sum = 0;
      ITEMS.forEach(it => {
        if(it.group!==group) return;
        const st = itemState.get(it.id); if(!st) return;
        const applies = it.applies==="both" || it.applies===scenario;
        if(!applies) return;
        if(it.isCemetery && !cemeteryOn) return;
        if(!st.enabled) return;
        const qty = it.qtyFactor ? (st.qty||1) : 1;
        sum += (Number(st.amount)||0) * qty * multiplier;
      });
      return sum;
    }

    function renderSummary(){
      const summary = document.getElementById("summary");
      summary.innerHTML = "";
      const order = ["funeral","transport","ceremony","burial","cremation"];
      order.forEach(g => {
        const val = groupSubtotal(g);
        if(val<=0) return;
        const div = document.createElement("div");
        div.className="bucket";
        const name = document.createElement("span");
        name.className="name";
        name.textContent = (
          g==="funeral" ? "Funeral home services" :
          g==="transport" ? "Transportation" :
          g==="ceremony" ? "Viewing & ceremony" :
          g==="burial" ? "Burial & cemetery" : "Cremation"
        );
        const amt = document.createElement("span");
        amt.className="amt";
        amt.textContent = fmtUSD(val);
        div.appendChild(name); div.appendChild(amt);
        summary.appendChild(div);
      });
      const total = grandTotal();
      document.getElementById("grandTotal").textContent = fmtUSD(total);
    }

    function grandTotal(){
      return GROUPS.reduce((acc,g)=> acc + groupSubtotal(g), 0);
    }

    function renderAll(){
      renderItems();
      renderSummary();
    }

    // ----- Controls -----
    function setToggle(elTrue, elFalse, isTrue){
      elTrue.setAttribute("aria-pressed", isTrue ? "true" : "false");
      elFalse.setAttribute("aria-pressed", isTrue ? "false" : "true");
    }

    const btnBurial = document.getElementById("opt-burial");
    const btnCrem = document.getElementById("opt-cremation");
    const svcFull = document.getElementById("svc-full");
    const svcMem = document.getElementById("svc-mem");
    const svcNone = document.getElementById("svc-none");
    const openYes = document.getElementById("open-yes");
    const openNo = document.getElementById("open-no");
    const rowOpen = document.getElementById("row-open-casket");
    const cemOn = document.getElementById("cem-on");
    const cemOff = document.getElementById("cem-off");

    btnBurial.addEventListener("click", () => { snapshot(); scenario="burial"; setToggle(btnBurial,btnCrem,true); updateRules(); });
    btnCrem.addEventListener("click", () => { snapshot(); scenario="cremation"; setToggle(btnBurial,btnCrem,false); updateRules(); });
    svcFull.addEventListener("click", () => { snapshot(); serviceLevel="full"; svcFull.setAttribute("aria-pressed","true"); svcMem.setAttribute("aria-pressed","false"); svcNone.setAttribute("aria-pressed","false"); updateRules(); });
    svcMem.addEventListener("click", () => { snapshot(); serviceLevel="mem"; svcFull.setAttribute("aria-pressed","false"); svcMem.setAttribute("aria-pressed","true"); svcNone.setAttribute("aria-pressed","false"); updateRules(); });
    svcNone.addEventListener("click", () => { snapshot(); serviceLevel="none"; svcFull.setAttribute("aria-pressed","false"); svcMem.setAttribute("aria-pressed","false"); svcNone.setAttribute("aria-pressed","true"); updateRules(); });
    openYes.addEventListener("click", () => { snapshot(); openCasket=true; setToggle(openYes,openNo,true); updateRules(); });
    openNo.addEventListener("click", () => { snapshot(); openCasket=false; setToggle(openYes,openNo,false); updateRules(); });
    cemOn.addEventListener("click", () => { snapshot(); cemeteryOn=true; setToggle(cemOn,cemOff,true); updateRules(); });
    cemOff.addEventListener("click", () => { snapshot(); cemeteryOn=false; setToggle(cemOn,cemOff,false); updateRules(); });

    stateSelect.addEventListener("change", () => { snapshot(); applyState(); });

    function updateRules(){
      rowOpen.style.display = (serviceLevel==="full") ? "" : "none";
      ITEMS.forEach(it => {
        const st = itemState.get(it.id);
        st.enabled = defaultEnabled(it);
        if(it.id==="refrigeration" && st.enabled && (!st.qty || st.qty<1)) st.qty = 1;
      });
      renderAll();
    }

    // Toggles for collapsible sections (start open by default)
    itemsToggle.addEventListener("click", () => {
      const showing = itemsSection.style.display!=="" ? false : true;
      itemsSection.style.display = showing ? "none" : "";
      itemsToggle.textContent = showing ? "Show itemized costs" : "Hide itemized costs";
      if(!showing) itemsSection.scrollIntoView({behavior:"smooth",block:"start"});
    });
    optionsToggle.addEventListener("click", () => {
      const showing = optionsSection.style.display!=="" ? false : true;
      optionsSection.style.display = showing ? "none" : "";
      optionsToggle.textContent = showing ? "Show options" : "Hide options";
      if(!showing) optionsSection.scrollIntoView({behavior:"smooth",block:"start"});
    });

    // Undo / Reset
    document.getElementById("btnPrint").addEventListener("click", () => window.print());
    document.getElementById("btnCSV").addEventListener("click", downloadCSV);

    function downloadCSV(){
      const lines=[["Group","Item","Amount","Qty","Included","Adjusted line total (USD)"]];
      ITEMS.forEach(it => {
        const st = itemState.get(it.id);
        if(!st) return;
        const applies = it.applies==="both" || it.applies===scenario;
        if(!applies) return;
        if(it.isCemetery && !cemeteryOn) return;
        const qty = it.qtyFactor ? (st.qty||1) : 1;
        const line = (Number(st.amount)||0) * qty * multiplier;
        lines.push([it.group,it.label,(Number(st.amount)||0).toFixed(0),qty,st.enabled?"Yes":"No",line.toFixed(0)]);
      });
      lines.push(["","","","","Grand total", grandTotal().toFixed(0)]);
      const csv = lines.map(r => r.map(v => `"${String(v).replace(/"/g,'""')}"`).join(",")).join("\\n");
      const blob = new Blob([csv], {type:"text/csv;charset=utf-8;"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a"); a.href=url; a.download="quietpath-funeral-estimate.csv"; a.click(); URL.revokeObjectURL(url);
    }

    // Boot
    function boot(){
      buildStateSelect();
      initDefaults();
      renderAll();
    }
    boot();
  </script>
</body>
</html>
