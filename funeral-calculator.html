<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Funeral Cost Calculator</title>
  <style>
    /* QuietPath base tokens */
    :root{
      --bg:#fcfbf9; --fg:#111; --muted:#6b7280;
      --blue:#5a7da3; --plum:#6e608c; --sand:#e8dcc8; --white:#fff;
      --border:#e5e7eb; --focus:#ffbf47;
    }

    /* Reset-ish */
    html,body{margin:0;padding:0;background:var(--bg);color:var(--fg);font-family:Lato,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;line-height:1.6;font-size:16px;}
    a{color:var(--blue);text-decoration:none;} a:hover{text-decoration:underline;}

    .container{max-width:1200px;margin:0 auto;padding:16px;}
    .layout{display:grid;grid-template-columns:340px 1fr;gap:16px;}
    @media(max-width:900px){.layout{grid-template-columns:1fr;}}

    .card{background:var(--white);border:1px solid var(--border);border-radius:12px;padding:14px;box-shadow:0 1px 0 rgba(0,0,0,.02);}
    .section-title{font-family:Raleway,Lato,sans-serif;font-weight:800;color:var(--plum);margin:0 0 10px;}

    .lede{color:var(--muted);max-width:72ch;}

    /* Estimate section */
    .grand{display:flex;justify-content:space-between;align-items:baseline;font-size:2rem;font-weight:800;color:var(--blue);}
    .grand span:first-child{color:var(--fg);font-weight:600;font-size:1.1rem;opacity:.8;}
    .summary{padding-top:12px;border-top:1px solid var(--border);}
    .summary .bucket{display:flex;justify-content:space-between;align-items:baseline;padding:2px 0;}
    .summary .bucket .name{color:var(--muted);}
    .summary .bucket .amt{font-variant-numeric:tabular-nums;}
    .rail{position:sticky;top:16px;z-index:2;}
    .rail .notes-desktop{display:block;}
    @media(max-width:900px){.rail{position:static;}.rail .notes-desktop{display:none;}}

    /* Controls */
    .controls{display:flex;flex-direction:column;gap:12px;margin-bottom:12px;}
    .controls .row{display:flex;align-items:center;justify-content:space-between;gap:12px;}
    .controls .muted{color:var(--muted);font-size:.9rem;font-weight:600;min-width:110px;}
    .controls .pill{padding:5px 12px;border:1px solid var(--border);border-radius:99px;background:var(--bg);cursor:pointer;transition:all .1s ease-in-out;font-size:.85rem;line-height:1.4;}
    .controls .pill:hover{background:var(--sand);}
    .controls .pill[aria-pressed="true"]{background:var(--blue);color:var(--white);border-color:var(--blue);}
    .controls .togglebar{display:flex;gap:4px;flex:1;}
    /* Adjusted the styling for the select dropdown to not expand fully on desktop */
    .controls select{
      font-size:.9rem;
      border:1px solid var(--border);
      background:var(--bg);
      border-radius:6px;
      padding:4px 8px;
      font-family:inherit;
      max-width: 250px; /* New rule to constrain width on desktop */
    }
    .controls .btn.ghost{color:var(--blue);border:1px solid transparent;background:transparent;}

    /* Buttons */
    .btn{padding:8px 16px;font-size:.9rem;border-radius:99px;cursor:pointer;border:1px solid var(--blue);background:var(--blue);color:var(--white);transition:all .1s ease-in-out;font-family:inherit;line-height:1.4;}
    .btn:hover{filter:brightness(1.1);}
    .btn.secondary{background:var(--bg);color:var(--muted);border-color:var(--border);}
    .btn.secondary:hover{border-color:var(--muted);}
    .btn.ghost{background:transparent;border:1px solid transparent;color:var(--blue);padding:4px 8px;font-size:.85rem;text-decoration:underline;}
    .btn.ghost:hover{text-decoration:none;}
    .btn.inline{background:transparent;border:0;color:var(--blue);padding:0;font-size:.85rem;}

    /* Table */
    table{width:100%;border-collapse:collapse;margin-top:4px;}
    table td,table th{padding:6px;vertical-align:top;border-bottom:1px solid #f3f4f6;}
    table th{text-align:left;color:var(--muted);font-weight:500;font-size:.9rem;padding-top:0;}
    table tbody tr:last-child td{border-bottom:none;}
    .amount.editing{display:flex;gap:4px;width:100%;}
    .amount.editing input{width:100%;max-width:120px;border:1px solid var(--border);padding:2px 4px;border-radius:4px;font-variant-numeric:tabular-nums;text-align:right;}
    .amount.editing input[type="number"]::-webkit-inner-spin-button,
    .amount.editing input[type="number"]::-webkit-outer-spin-button {-webkit-appearance: none; margin: 0;}
    .amount.editing input:focus{outline:2px solid var(--focus);outline-offset:1px;border-color:transparent;}

    .row-disabled{opacity:.5;font-style:italic;}
    .row-disabled .amount{color:#9aa0a6;}

    /* Actions */
    .col-item{width:60%;}
    .col-amt{width:20%;text-align:right;font-variant-numeric:tabular-nums;}
    .col-act{width:20%;text-align:right;}

    /* Groups */
    .group h3{display:flex;justify-content:space-between;align-items:baseline;gap:12px;margin:6px 0 8px;}
    .group .subtotal{font-weight:800;color:#222;}
    .group + .group{margin-top:16px;}
    .group + .group h3{padding-top:16px;border-top:1px solid var(--border);}
    .group .fine-print{margin-top:12px;}
    .fine-print{font-size:.8rem;color:var(--muted);}
    .fine-print + .fine-print{margin-top:6px;}

    /* See more */
    .moreline{margin-top:6px;text-align:left;}
    .moreline .btn.linkish{text-decoration:underline;}
    .moreline .btn.linkish:hover{text-decoration:none;}

    /* Disabled rows */
    .row-disabled td.col-item,
    .row-disabled td.col-amt .amount{color:#9aa0a6;text-decoration:line-through;}
    .row-disabled td.col-act{opacity:.85;}

    /* Footer actions */
    .footer-actions{display:flex;gap:12px;justify-content:flex-end;margin-top:12px;}

    /* Mobile dock (total only) */
    .mobile-dock{position:sticky;bottom:0;left:0;right:0;background:var(--blue);border-top:1px solid var(--border);color:var(--white);z-index:1;padding:12px;display:none;}
    .mobile-dock .dock-total{display:flex;justify-content:space-between;align-items:baseline;font-size:1.4rem;font-weight:500;}
    .mobile-dock .dock-total strong{font-size:1.8rem;font-weight:800;}
    @media(max-width:900px){.mobile-dock{display:block;}}
    
    /* NEW: Mobile-specific styles for better responsiveness */
    @media (max-width: 600px) {
        .container {
            padding: 12px;
        }
        h1 {
            font-size: 1.8rem;
        }
        .grand {
            font-size: 1.6rem;
        }
        .grand span:first-child {
            font-size: 1rem;
        }
        .controls .row {
            flex-direction: column;
            align-items: flex-start;
        }
        .controls .togglebar {
            flex-wrap: wrap; /* This is the key change to prevent horizontal overflow */
            gap: 8px;
            width: 100%;
        }
        .controls .pill {
            flex: 1 1 auto;
            text-align: center;
        }
        /* New rule to make the select dropdown full-width on mobile */
        .controls select {
          max-width: 100%;
          width: 100%;
        }
    }
  </style>
</head>
<body>

<div class="container">
  <h1>Funeral Cost Calculator</h1>
  <p class="lede">A starting point to see typical costs, without pressure to decide everything right now.</p>

  <div class="layout">
    <aside class="rail">
      <section class="card" aria-labelledby="estTitle" id="estimateCard">
        <h2 id="estTitle" class="section-title">Your Estimate</h2>
        <div class="grand"><span>Total</span><span id="grandTotal">$0</span></div>
        <div id="summary" class="summary" style="margin-top:10px;"></div>
      </section>
      <section class="notes-desktop">
        <div class="card">
          <p class="fine-print">Most Americans choose cremation (~62%), so we start with a cremation memorial by default.</p>
          <p class="fine-print"><strong>About these numbers:</strong> Based on national averages from public sources. Typical costs only â€” please consult your local funeral home or crematory for actual pricing.</p>
        </div>
      </section>
    </aside>

    <div class="main">
      <section class="card" id="optionsSection">
        <h2 class="section-title">Options</h2>
        <div class="controls">
          <div class="row">
            <label class="muted">Scenario</label>
            <div class="togglebar">
              <button class="pill" id="opt-burial" aria-pressed="false">Burial</button>
              <button class="pill" id="opt-cremation" aria-pressed="true">Cremation</button>
            </div>
          </div>

          <div class="row">
            <label class="muted">Service level</label>
            <div class="togglebar">
              <button class="pill" id="svc-full" aria-pressed="false">Full service</button>
              <button class="pill" id="svc-mem" aria-pressed="true">Memorial/Graveside only</button>
              <button class="pill" id="svc-none" aria-pressed="false">No service</button>
            </div>
          </div>

          <div class="row" id="row-open-casket" style="display:none;">
            <label class="muted">Open casket?</label>
            <div class="togglebar">
              <button class="pill" id="open-yes" aria-pressed="false">Yes</button>
              <button class="pill" id="open-no" aria-pressed="true">No</button>
            </div>
          </div>

          <div class="row">
            <label for="stateSelect" class="muted">State</label>
            <select id="stateSelect"></select>
          </div>

          <div class="row">
            <label class="muted">Cemetery costs</label>
            <div class="togglebar">
              <button class="pill" id="cem-on" aria-pressed="false">On</button>
              <button class="pill" id="cem-off" aria-pressed="true">Off</button>
            </div>
          </div>

          <div class="row">
            <button id="btnReset" class="btn ghost small">Reset defaults</button>
          </div>
        </div>

        <div style="margin-top:8px;">
          <button id="itemsToggle" class="btn secondary small">Show itemized costs</button>
        </div>
      </section>

      <section class="card" id="itemsSection" style="display:none; margin-top:16px;">
        <h2 class="section-title">Itemized costs</h2>

        <div class="group" id="grpFuneral">
          <h3>Funeral home services <span class="subtotal" id="subFuneral">$0</span></h3>
          <table>
            <colgroup><col class="col-item"><col class="col-amt"><col class="col-act"></colgroup>
            <thead><tr><th class="col-item">Item</th><th class="col-amt">Amount</th><th class="col-act">Actions</th></tr></thead>
            <tbody id="bodyFuneral"></tbody>
          </table>
          <div class="moreline" id="moreFuneral" style="display:none;"><button class="btn linkish" data-target="funeral">See more options</button></div>
        </div>

        <div class="group" id="grpTransport">
          <h3>Transportation <span class="subtotal" id="subTransport">$0</span></h3>
          <table>
            <colgroup><col class="col-item"><col class="col-amt"><col class="col-act"></colgroup>
            <thead><tr><th class="col-item">Item</th><th class="col-amt">Amount</th><th class="col-act">Actions</th></tr></thead>
            <tbody id="bodyTransport"></tbody>
          </table>
          <div class="moreline" id="moreTransport" style="display:none;"><button class="btn linkish" data-target="transport">See more options</button></div>
        </div>

        <div class="group" id="grpCeremony">
          <h3>Viewing & ceremony <span class="subtotal" id="subCeremony">$0</span></h3>
          <table>
            <colgroup><col class="col-item"><col class="col-amt"><col class="col-act"></colgroup>
            <thead><tr><th class="col-item">Item</th><th class="col-amt">Amount</th><th class="col-act">Actions</th></tr></thead>
            <tbody id="bodyCeremony"></tbody>
          </table>
          <div class="moreline" id="moreCeremony" style="display:none;"><button class="btn linkish" data-target="ceremony">See more options</button></div>
        </div>

        <div class="group" id="grpBurial">
          <h3>Burial & cemetery <span class="subtotal" id="subBurial">$0</span></h3>
          <table>
            <colgroup><col class="col-item"><col class="col-amt"><col class="col-act"></colgroup>
            <thead><tr><th class="col-item">Item</th><th class="col-amt">Amount</th><th class="col-act">Actions</th></tr></thead>
            <tbody id="bodyBurial"></tbody>
          </table>
          <div class="moreline" id="moreBurial" style="display:none;"><button class="btn linkish" data-target="burial">See more options</button></div>
        </div>

        <div class="group" id="grpCremation">
          <h3>Cremation <span class="subtotal" id="subCremation">$0</span></h3>
          <table>
            <colgroup><col class="col-item"><col class="col-amt"><col class="col-act"></colgroup>
            <thead><tr><th class="col-item">Item</th><th class="col-amt">Amount</th><th class="col-act">Actions</th></tr></thead>
            <tbody id="bodyCremation"></tbody>
          </table>
          <div class="moreline" id="moreCremation" style="display:none;"><button class="btn linkish" data-target="cremation">See more options</button></div>
        </div>

        <div class="footer-actions">
          <button id="btnPrint" class="btn secondary small">Print / Save as PDF</button>
          <button id="btnCSV" class="btn secondary small">Download CSV</button>
        </div>
      </section>

      <section class="bottom-notes">
        <div class="card">
          <p class="fine-print">Most Americans choose cremation (~62%), so we start with a cremation memorial by default.</p>
          <p class="fine-print"><strong>About these numbers:</strong> Based on national averages from public sources. Typical costs only â€” please consult your local funeral home or crematory for actual pricing.</p>
        </div>
      </section>
    </div>
  </div>
</div>

<div class="mobile-dock" id="mobileDock" role="region" aria-label="Total estimate">
  <div class="dock-wrap">
    <div class="dock-total">Total estimate: <strong id="dockTotalAmt">$0</strong></div>
  </div>
</div>

<script>
  /* QuietPath â€¢ Funeral Cost Calculator (separate JS)
     - Mobile bottom dock (total only)
     - "See more options" collapsed by default
     - CSV/Print buttons in the itemized footer
     - No header/footer or nav code included
  */
  (function(){
    // ----- State multipliers -----
    const STATE_MULT={"California":1.2,"New York":1.2,"Massachusetts":1.2,"Connecticut":1.2,"New Jersey":1.2,"District of Columbia":1.2,"Washington":1.2,"Oregon":1.2,"Hawaii":1.2,"Alaska":1.2,"Maryland":1.2,"Alabama":0.8,"Arkansas":0.8,"Mississippi":0.8,"Oklahoma":0.8,"Kentucky":0.8,"West Virginia":0.8,"Louisiana":0.8,"Tennessee":0.8,"Missouri":0.8,"New Mexico":0.8,"South Carolina":0.8,"Idaho":0.8};

    const ALL_STATES = ["National average"].concat("Alabama,Alaska,Arizona,Arkansas,California,Colorado,Connecticut,Delaware,District of Columbia,Florida,Georgia,Hawaii,Idaho,Illinois,Indiana,Iowa,Kansas,Kentucky,Louisiana,Maine,Maryland,Massachusetts,Michigan,Minnesota,Mississippi,Missouri,Montana,Nebraska,Nevada,New Hampshire,New Jersey,New Mexico,New York,North Carolina,North Dakota,Ohio,Oklahoma,Oregon,Pennsylvania,Rhode Island,South Carolina,South Dakota,Tennessee,Texas,Utah,Vermont,Virginia,Washington,Wisconsin,Wyoming".split(","));

    const GROUPS=["funeral","transport","ceremony","burial","cremation"];

    const OPTIONAL_ORDER = {ceremony:["flowers","programs","obituary","honorarium","catering"],burial:["liner","headstone","plot","opening","vault"],funeral:["refrigeration","presentation"],transport:[],cremation:[]};

    const ITEMS=[
      {id:"basic_services",label:"Basic services of funeral director and staff",base:2300,group:"funeral",applies:"both"},
      {id:"transfer",label:"Transfer of remains",base:350,group:"transport",applies:"both"},
      {id:"embalming",label:"Embalming",base:750,group:"funeral",applies:"burial"},
      {id:"viewing",label:"Viewing / visitation",base:450,group:"ceremony",applies:"both"},
      {id:"ceremony",label:"Funeral ceremony / memorial",base:500,group:"ceremony",applies:"both"},
      {id:"hearse",label:"Hearse",base:350,group:"transport",applies:"burial"},
      {id:"service_car",label:"Service car / van",base:150,group:"transport",applies:"both"},
      {id:"metal_casket",label:"Metal casket",base:2500,group:"burial",applies:"burial"},
      {id:"vault",label:"Vault",base:1500,group:"burial",applies:"burial",isCemetery:true},
      {id:"plot",label:"Cemetery plot",base:2000,group:"burial",applies:"both",isCemetery:true},
      {id:"opening",label:"Opening / closing grave",base:1200,group:"burial",applies:"both",isCemetery:true},
      {id:"headstone",label:"Headstone / marker",base:2000,group:"burial",applies:"both",isCemetery:true},
      {id:"cremation_fee",label:"Cremation fee",base:350,group:"cremation",applies:"cremation"},
      {id:"urn",label:"Urn",base:250,group:"cremation",applies:"cremation"},
      {id:"flowers",label:"Flowers",base:150,group:"ceremony",applies:"both",optional:true,enabled:false},
      {id:"programs",label:"Printed programs / memorial cards",base:180,group:"ceremony",applies:"both",optional:true,enabled:false},
      {id:"obituary",label:"Obituary / announcement fees",base:100,group:"ceremony",applies:"both",optional:true,enabled:false},
      {id:"honorarium",label:"Clergy / celebrant honorarium",base:200,group:"ceremony",applies:"both",optional:true,enabled:false},
      {id:"catering",label:"Family gathering / catering",base:300,group:"ceremony",applies:"both",optional:true,enabled:false},
      {id:"liner",label:"Grave liner (if not using vault)",base:900,group:"burial",applies:"burial",optional:true,enabled:false},
      {id:"presentation",label:"Presentation prep (dressing/cosmetics)",base:200,group:"funeral",applies:"burial",optional:true,enabled:false},
      {id:"refrigeration",label:"Refrigeration (per day)",base:100,group:"funeral",applies:"both",optional:true,enabled:false,qtyFactor:true,qty:1}
    ];

    const stateSelect=document.getElementById("stateSelect");
    const itemsToggle=document.getElementById("itemsToggle");
    const itemsSection=document.getElementById("itemsSection");
    const summaryEl=document.getElementById("summary");
    const grandEl=document.getElementById("grandTotal");
    const dockTotal=document.getElementById("dockTotalAmt");

    const bodies={funeral:document.getElementById("bodyFuneral"),transport:document.getElementById("bodyTransport"),ceremony:document.getElementById("bodyCeremony"),burial:document.getElementById("bodyBurial"),cremation:document.getElementById("bodyCremation")};
    const subEls={funeral:document.getElementById("subFuneral"),transport:document.getElementById("subTransport"),ceremony:document.getElementById("subCeremony"),burial:document.getElementById("subBurial"),cremation:document.getElementById("subCremation")};
    const moreLines={funeral:document.getElementById("moreFuneral"),transport:document.getElementById("moreTransport"),ceremony:document.getElementById("moreCeremony"),burial:document.getElementById("moreBurial"),cremation:document.getElementById("moreCremation")};
    const moreOpen={funeral:false,transport:false,ceremony:false,burial:false,cremation:false};

    let scenario="cremation",serviceLevel="mem",cemeteryOn=false,openCasket=false,multiplier=1.0;
    const itemState=new Map();

    function setPressed(el,on){ if(!el)return; el.setAttribute("aria-pressed", on?"true":"false"); }

    function defaultEnabled(it){
      const applies=it.applies==="both"||it.applies===scenario;
      if(!applies)return false;
      if(it.isCemetery&&!cemeteryOn)return false;
      if(it.id==="viewing") return serviceLevel==="full";
      if(it.id==="ceremony") return (serviceLevel==="full"||serviceLevel==="mem");
      if(it.id==="service_car") return serviceLevel==="full";
      if(it.id==="hearse") return scenario==="burial";
      if(it.id==="embalming"){ if(scenario==="cremation")return false; if(serviceLevel!=="full")return false; return openCasket; }
      if(it.id==="presentation") return serviceLevel==="full"&&openCasket&&scenario==="burial";
      if(it.id==="refrigeration"){ const emb=(scenario==="burial"&&serviceLevel==="full"&&openCasket); return !emb&&(serviceLevel!=="none"); }
      if(it.optional&&it.enabled===false)return false;
      return true;
    }
    function initDefaults(){
      itemState.clear();
      ITEMS.forEach(it=>itemState.set(it.id,{
        enabled:defaultEnabled(it),
        amount:it.base,
        qty:it.qtyFactor?(it.qty||1):1
      }));
    }

    const fmtUSD=n=>Number(n).toLocaleString(undefined,{style:"currency",currency:"USD",maximumFractionDigits:0});

    function buildStateSelect(){
      if(!stateSelect) return;
      stateSelect.innerHTML="";
      ALL_STATES.forEach(s=>{
        const o=document.createElement("option");o.value=s;o.textContent=s;stateSelect.appendChild(o);
      });
      stateSelect.value="National average"; multiplier=1.0;
      stateSelect.addEventListener("change",()=>{
        const s=stateSelect.value; multiplier=(s==="National average")?1.0:(STATE_MULT[s]||1.0); renderAll();
      });
    }

    function groupSubtotal(group){
      let sum=0;
      ITEMS.forEach(it=>{
        if(it.group!==group) return;
        const st=itemState.get(it.id);
        const applies=it.applies==="both"||it.applies===scenario; if(!applies) return;
        if(it.isCemetery&&!cemeteryOn) return;
        if(!st.enabled) return;
        const qty=it.qtyFactor?(st.qty||1):1;
        sum+=(Number(st.amount)||0)*qty*multiplier;
      });
      return sum;
    }

    function renderSummary(){
      summaryEl.innerHTML="";
      GROUPS.forEach(g=>{
        const val=groupSubtotal(g);
        if(val<=0) return;
        const div=document.createElement("div"); div.className="bucket";
        const name=document.createElement("span"); name.className="name";
        name.textContent=(g==="funeral"?"Funeral home services":g==="transport"?"Transportation":g==="ceremony"?"Viewing & ceremony":g==="burial"?"Burial & cemetery":"Cremation");
        const amt=document.createElement("span"); amt.className="amt"; amt.textContent=fmtUSD(val);
        div.appendChild(name); div.appendChild(amt); summaryEl.appendChild(div);
      });
      const total=grandTotal();
      grandEl.textContent=fmtUSD(total);
      if(dockTotal) dockTotal.textContent=fmtUSD(total);
    }

    function grandTotal(){ return GROUPS.reduce((acc,g)=>acc+groupSubtotal(g),0); }

    function makeRow(it,isDisabled){
      const st=itemState.get(it.id);
      const row=document.createElement("tr"); if(isDisabled) row.classList.add("row-disabled");
      const tdItem=document.createElement("td"); tdItem.className="col-item"; tdItem.textContent=it.label + (it.qtyFactor && st.qty>1 ? ` Ã— ${st.qty}` : "");
      const tdAmt=document.createElement("td"); tdAmt.className="col-amt"; const span=document.createElement("span"); span.className="amount";
      const line=(st.amount||0)*(it.qtyFactor?(st.qty||1):1); span.textContent=fmtUSD(line); tdAmt.appendChild(span);
      const tdAct=document.createElement("td"); tdAct.className="col-act"; const wrap=document.createElement("div");

      if(!isDisabled){
        const edit=document.createElement("button"); edit.className="btn inline"; edit.textContent="Edit";
        edit.addEventListener("click",()=>{
          tdAmt.innerHTML="";
          const w=document.createElement("div"); w.className="amount editing";
          const input=document.createElement("input"); input.type="number"; input.inputMode="numeric"; input.pattern="[0-9]*"; input.min="0"; input.step="50"; input.value=st.amount; w.appendChild(input);
          if(it.qtyFactor){ const q=document.createElement("input"); q.type="number"; q.inputMode="numeric"; q.pattern="[0-9]*"; q.min="1"; q.step="1"; q.value=st.qty||1; q.style.width="70px"; q.setAttribute("aria-label","Quantity"); w.appendChild(q);
            q.addEventListener("blur",()=>{ st.qty=Math.max(1,Number(q.value)||1); renderAll();}); q.addEventListener("keydown",e=>{if(e.key==="Enter"){q.blur();}}); }
          tdAmt.appendChild(w); input.focus();
          const commit=()=>{ st.amount=Number(input.value)||0; renderAll(); }; input.addEventListener("blur",commit); input.addEventListener("keydown",e=>{if(e.key==="Enter"){input.blur();}});
        });

        const sep=document.createElement("span"); sep.textContent=" | "; sep.className="muted";
        const remove=document.createElement("button"); remove.className="btn inline"; remove.textContent="Remove";
        remove.addEventListener("click",()=>{ st.enabled=false; renderAll(); });
        wrap.appendChild(edit); wrap.appendChild(sep); wrap.appendChild(remove);
      } else {
        const add=document.createElement("button"); add.className="btn inline"; add.textContent="Add";
        add.addEventListener("click",()=>{ st.enabled=true; renderAll(); });
        wrap.appendChild(add);
      }

      tdAct.appendChild(wrap);
      row.appendChild(tdItem); row.appendChild(tdAmt); row.appendChild(tdAct);
      return row;
    }

    function renderGroup(group){
      const tbody=bodies[group]; if(!tbody) return; tbody.innerHTML="";
      const enabled=[], disabled=[];
      ITEMS.forEach(it=>{
        if(it.group!==group) return;
        const applies=it.applies==="both"||it.applies===scenario; 
        if(!applies){ disabled.push(it); return; }
        if(it.isCemetery && !cemeteryOn){ disabled.push(it); return; }
        const st=itemState.get(it.id);
        (st.enabled ? enabled : disabled).push(it);
      });

      enabled.forEach(it => tbody.appendChild(makeRow(it, false)));

      if(moreOpen[group]){
        const order = OPTIONAL_ORDER[group]||[];
        disabled.sort((a,b)=> (order.indexOf(a.id)+1 || 999) - (order.indexOf(b.id)+1 || 999));
        disabled.forEach(it => tbody.appendChild(makeRow(it, true)));
      }

      const count = disabled.length;
      const line = moreLines[group];
      if(line){
        if(count>0){
          line.style.display="";
          const btn=line.querySelector("button");
          btn.textContent = (moreOpen[group] ? "Hide extra items" : `See more options (${count})`);
          btn.onclick = ()=>{ moreOpen[group]=!moreOpen[group]; renderAll(); };
        } else {
          line.style.display="none";
        }
      }

      if(subEls[group]) subEls[group].textContent = fmtUSD(groupSubtotal(group));
      const groupEl = document.getElementById("grp"+group.charAt(0).toUpperCase()+group.slice(1));
      if(groupEl) groupEl.style.display = (enabled.length>0 || (moreOpen[group] && disabled.length>0)) ? "" : "none";
    }

    function renderAll(){ GROUPS.forEach(renderGroup); renderSummary(); }

    // Button wiring
    const btnBurial=document.getElementById("opt-burial"),
          btnCrem=document.getElementById("opt-cremation"),
          svcFull=document.getElementById("svc-full"),
          svcMem=document.getElementById("svc-mem"),
          svcNone=document.getElementById("svc-none"),
          openYes=document.getElementById("open-yes"),
          openNo=document.getElementById("open-no"),
          rowOpen=document.getElementById("row-open-casket"),
          cemOnBtn=document.getElementById("cem-on"),
          cemOffBtn=document.getElementById("cem-off");

    function updateRules(){
      if(rowOpen) rowOpen.style.display=(serviceLevel==="full"&&scenario==="burial")?"":"none";
      ITEMS.forEach(it=>{ const st=itemState.get(it.id); st.enabled=defaultEnabled(it); if(it.id==="refrigeration"&&st.enabled&&(!st.qty||st.qty<1)) st.qty=1; });
      renderAll();
    }

    btnBurial?.addEventListener("click",()=>{scenario="burial";setPressed(btnBurial,true);setPressed(btnCrem,false);updateRules();});
    btnCrem?.addEventListener("click",()=>{scenario="cremation";setPressed(btnBurial,false);setPressed(btnCrem,true);updateRules();});
    svcFull?.addEventListener("click",()=>{serviceLevel="full";setPressed(svcFull,true);setPressed(svcMem,false);setPressed(svcNone,false);updateRules();});
    svcMem?.addEventListener("click",()=>{serviceLevel="mem";setPressed(svcFull,false);setPressed(svcMem,true);setPressed(svcNone,false);updateRules();});
    svcNone?.addEventListener("click",()=>{serviceLevel="none";setPressed(svcFull,false);setPressed(svcMem,false);setPressed(svcNone,true);updateRules();});
    openYes?.addEventListener("click",()=>{openCasket=true;setPressed(openYes,true);setPressed(openNo,false);updateRules();});
    openNo?.addEventListener("click",()=>{openCasket=false;setPressed(openYes,false);setPressed(openNo,true);updateRules();});
    cemOnBtn?.addEventListener("click",()=>{cemeteryOn=true;setPressed(cemOnBtn,true);setPressed(cemOffBtn,false);updateRules();});
    cemOffBtn?.addEventListener("click",()=>{cemeteryOn=false;setPressed(cemOnBtn,false);setPressed(cemOffBtn,true);updateRules();});

    // Items show/hide
    itemsToggle?.addEventListener("click",(e)=>{
      e.preventDefault();
      const hidden=itemsSection.style.display==="none";
      itemsSection.style.display=hidden?"":"none";
      itemsToggle.textContent=hidden?"Hide itemized costs":"Show itemized costs";
    });

    // CSV / Print
    document.getElementById("btnPrint")?.addEventListener("click",()=>window.print());
    document.getElementById("btnCSV")?.addEventListener("click",()=>{
      const lines=[["Group","Item","Amount","Qty","Included","Adjusted line total (USD)"]];
      ITEMS.forEach(it=>{
        const st=itemState.get(it.id); if(!st)return;
        const applies=it.applies==="both"||it.applies===scenario; if(!applies)return;
        if(it.isCemetery&&!cemeteryOn)return;
        const qty=it.qtyFactor?(st.qty||1):1;
        const line=(Number(st.amount)||0)*qty*multiplier;
        lines.push([it.group,it.label,(Number(st.amount)||0).toFixed(0),qty,st.enabled?"Yes":"No",line.toFixed(0)]);
      });
      lines.push(["","","","","Grand total",grandTotal().toFixed(0)]);
      const csv=lines.map(r=>r.map(v=>`"${String(v).replace(/"/g,'""')}"`).join(",")).join("\n");
      const blob=new Blob([csv],{type:"text/csv;charset=utf-8;"}); const url=URL.createObjectURL(blob);
      const a=document.createElement("a"); a.href=url; a.download="quietpath-funeral-estimate.csv"; a.click(); URL.revokeObjectURL(url);
    });

    // Reset
    document.getElementById("btnReset")?.addEventListener("click",()=>{
      scenario="cremation";serviceLevel="mem";cemeteryOn=false;openCasket=false;multiplier=1.0;
      setPressed(btnBurial,false);setPressed(btnCrem,true);setPressed(svcFull,false);setPressed(svcMem,true);setPressed(svcNone,false);
      setPressed(openYes,false);setPressed(openNo,true);setPressed(cemOnBtn,false);setPressed(cemOffBtn,true);
      if(stateSelect) stateSelect.value="National average"; initDefaults(); renderAll();
      if(itemsSection && itemsSection.style.display!=="none"){itemsToggle.click();}
      window.scrollTo({top:0,behavior:"smooth"});
    });

    function renderAll(){ GROUPS.forEach(renderGroup); renderSummary(); }
    function grandTotal(){ return GROUPS.reduce((acc,g)=>acc+groupSubtotal(g),0); }

    function boot(){
      buildStateSelect();
      initDefaults();
      renderAll();
    }

    if(document.readyState === "loading"){
      document.addEventListener("DOMContentLoaded", boot);
    } else {
      boot();
    }

  })();
</script>

</body>
</html>
